<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="区块链技术实践-使用Java搭建简单的区块链系统"><meta name="keywords" content="软件开发,区块链,Java"><meta name="author" content="GiyaYon"><meta name="copyright" content="GiyaYon"><title>区块链技术实践-使用Java搭建简单的区块链系统 | GiyaYon's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="GiyaYon's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">1.定义区块结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%8C%BA%E5%9D%97Block-java"><span class="toc-number">2.1.</span> <span class="toc-text">基础区块Block.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B1%BBStringUtil-java"><span class="toc-number">2.2.</span> <span class="toc-text">工具类StringUtil.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Gson%E7%B1%BB%E8%BE%93%E5%87%BAjson%E6%A0%BC%E5%BC%8F%E4%BF%A1%E6%81%AF"><span class="toc-number">2.3.</span> <span class="toc-text">使用Gson类输出json格式信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">2.挖矿与验证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">3.通信实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8WebSocket%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%8C%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">4.1.</span> <span class="toc-text">1.使用WebSocket实现服务器和客户端的网络通信基础模块，引入依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-SocketServer-java"><span class="toc-number">4.2.</span> <span class="toc-text">2.SocketServer.java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-socketClient-java"><span class="toc-number">4.3.</span> <span class="toc-text">3.socketClient.java</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">4.网络服务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%B6%88%E6%81%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.</span> <span class="toc-text">1.消息实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.2.</span> <span class="toc-text">2.定义接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">5.3.</span> <span class="toc-text">3.实现简易消息处理的服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%9E%E7%8E%B0%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">5.4.</span> <span class="toc-text">4.实现客户端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">5.实现Web API查询服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">后言</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/GiyaYon/mypicGo/master/header.jpg"></div><div class="author-info__name text-center">GiyaYon</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/GiyaYon">查看项目</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">7</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">9</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">10</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">GiyaYon's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/github">GitHub</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">区块链技术实践-使用Java搭建简单的区块链系统</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-05-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">软件工程</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%8C%E6%A1%8C%E9%9D%A2%E5%BA%94%E7%94%A8/">软件开发，桌面应用</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1>前言</h1>
<p>本文欲实现的需求：</p>
<ol>
<li>
<p><strong>设计区块和链结构</strong>：你可以创建一个<code>Block</code>类来表示区块，其中包含属性：如时间戳、交易数据、前一个区块的哈希值、当前区块的哈希值等。然后创建一个<code>Blockchain</code>类来表示整个区块链，其中包含一个<code>Block</code>对象的列表来存储所有的区块。</p>
</li>
<li>
<p><strong>挖矿</strong>：你可以在<code>Blockchain</code>类中添加一个挖矿方法，该方法接收一组交易数据作为参数，并创建一个新的区块。在这个过程中，你需要执行工作量证明算法来寻找满足特定条件的哈希值。</p>
<p>挖矿是区块链中的一个重要过程，它指的是通过解决复杂的计算问题来创建新区块并获得奖励的过程。在一个基于工作量证明算法（Proof of Work，PoW）的区块链系统中，挖矿通常包括以下几个步骤：</p>
<ol>
<li><s><strong>收集交易数据</strong>：首先，挖矿节点需要收集一组未经确认的交易数据，并将其打包到一个新区块中。</s></li>
<li><strong>计算区块哈希值</strong>：其次，挖矿节点需要对新区块进行哈希运算，以计算出它的哈希值。这一步通常需要使用特定的哈希算法（如SHA-256）。</li>
<li><strong>执行工作量证明算法</strong>：然后，挖矿节点需要执行工作量证明算法来寻找满足特定条件的哈希值。具体来说，它需要不断改变新区块中的某个字段（如随机数），并重新计算哈希值，直到找到一个以特定数量的零开头的哈希值。</li>
<li><strong>广播新区块</strong>：最后，当挖矿节点成功找到满足条件的哈希值时，它就可以将新区块广播到整个网络中，并获得相应的奖励。</li>
</ol>
<p>以上就是一个简单的挖矿过程。不同的区块链系统可能会有所不同，请根据实际情况进行调整。</p>
</li>
<li>
<p><strong>设计P2P网络</strong>：你可以使用Java中的网络编程技术（如Socket）来实现P2P网络。每个节点都可以监听特定端口，并与其他节点建立连接。</p>
</li>
<li>
<p><strong>新产生的区块同步到其它结点</strong>：当一个节点成功挖出一个新区块时，它应该将这个新区块广播到整个网络中，让其他节点都能接收到这个新区块。</p>
</li>
<li>
<p><strong>验证其它结点广播的区块</strong>：当一个节点接收到其他节点广播的新区块时，它应该对这个新区块进行验证（例如检查哈希值是否满足特定条件）。如果验证通过，则将这个新区块加入本地的区块链中。</p>
<p>当一个节点接收到其他节点广播的新区块时，它应该对这个新区块进行验证。验证过程通常包括以下几个步骤：</p>
<ol>
<li><strong>检查区块结构</strong>：首先，你需要检查新区块的结构是否符合预期，例如它是否包含所有必要的字段（如时间戳、交易数据、前一个区块的哈希值等）。</li>
<li><strong>检查前一个区块的哈希值</strong>：其次，你需要检查新区块中存储的前一个区块的哈希值是否与本地区块链中最后一个区块的哈希值相同。</li>
<li><strong>检查工作量证明</strong>：然后，你需要检查新区块是否满足工作量证明算法的要求。具体来说，你需要计算新区块的哈希值，并检查它是否满足特定条件（例如以特定数量的零开头）。</li>
<li><s><strong>验证交易数据</strong>：最后，你需要验证新区块中包含的所有交易数据。这一步通常涉及到对每笔交易进行签名验证、双花检测等操作。</s></li>
</ol>
<p>如果新区快通过了以上所有验证步骤，则说明它是有效的，并可以被加入到本地区块链中。否则，应该将其忽略并继续监听网络中其他节点广播的新区快。</p>
</li>
<li>
<p><strong>设计提供API服务</strong>：你可以使用Java Web技术（如Servlet）来实现API服务。例如，你可以创建一个Servlet来处理获取所有区块数据的请求，并返回JSON格式的数据。</p>
<img src="https://raw.githubusercontent.com/GiyaYon/mypicGo/master/%E5%8C%BA%E5%9D%97%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E2%80%94%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92%E8%BF%87%E7%A8%8B.png" style="zoom: 80%;" />
<center>本篇使用JAVA语言开发区块链系统</center>
<p>在基础层方面，构建基本区块结构，进行哈希处理，矿工挖矿的功能，后续将交易模块嵌入区块结构里面，而区块以区块组成的链作为账本记录。</p>
</li>
</ol>
<h1>1.定义区块结构</h1>
<h2 id="基础区块Block-java">基础区块Block.java</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.giyaYon.arithmetic.StringUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Block</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 区块的序号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> index;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 哈希值，作为唯一标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String hash;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上一个区块哈希值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String previousHash;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;TransactionData&gt; data;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeStamp;</span><br><span class="line">	<span class="comment">//工作量证明</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> nonce;</span><br><span class="line">	<span class="comment">// 矿工挖矿控制</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Block Constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> previousHash</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Block</span><span class="params">(<span class="type">int</span> index, ArrayList&lt;TransactionData&gt; data, String previousHash )</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.index = index;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="built_in">this</span>.previousHash = previousHash;</span><br><span class="line">        <span class="built_in">this</span>.timeStamp = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Making sure we do this after we set the other values.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.hash = calculateHash();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">calculateHash</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">calculatedhash</span> <span class="operator">=</span> StringUtil.applySha256(</span><br><span class="line">                previousHash +</span><br><span class="line">                        Long.toString(timeStamp) +</span><br><span class="line">                        Integer.toString(nonce) +</span><br><span class="line">                        data</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> calculatedhash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">mineBlock</span> <span class="params">(<span class="type">int</span> difficulty)</span>&#123;</span><br><span class="line">        <span class="comment">// Create a string with difficulty * &quot;0&quot;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[difficulty]).replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">        <span class="keyword">while</span>(!hash.substring( <span class="number">0</span>, difficulty).equals(target)) &#123;</span><br><span class="line">            nonce ++;</span><br><span class="line">            hash = calculateHash();</span><br><span class="line">            <span class="keyword">if</span>(!running)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Block Mined despected!!! &quot;</span> );</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;Block Mined!!! : &quot;</span> + hash);</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopMining</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        running = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Block&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;index=&quot;</span> + index +</span><br><span class="line">                <span class="string">&quot;, hash=&#x27;&quot;</span> + hash + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, previousHash=&#x27;&quot;</span> + previousHash + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, data=&quot;</span> + data +</span><br><span class="line">                <span class="string">&quot;, timeStamp=&quot;</span> + timeStamp +</span><br><span class="line">                <span class="string">&quot;, nonce=&quot;</span> + nonce +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在构造函数里，先对基础属性赋值，通过SHA256算法对数据进行<code>数字摘要加密</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">calculateHash</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">calculatedhash</span> <span class="operator">=</span> StringUtil.applySha256(</span><br><span class="line">            previousHash +</span><br><span class="line">                    Long.toString(timeStamp) +</span><br><span class="line">                    Integer.toString(nonce) +</span><br><span class="line">                    data</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> calculatedhash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>矿工挖矿使用到的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">mineBlock</span> <span class="params">(<span class="type">int</span> difficulty)</span>&#123;</span><br><span class="line">    <span class="comment">// Create a string with difficulty * &quot;0&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[difficulty]).replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    <span class="keyword">while</span>(!hash.substring( <span class="number">0</span>, difficulty).equals(target)) &#123;</span><br><span class="line">        nonce ++;</span><br><span class="line">        hash = calculateHash();</span><br><span class="line">        <span class="keyword">if</span>(!running)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Block Mined despected!!! &quot;</span> );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;Block Mined!!! : &quot;</span> + hash);</span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopMining</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    running = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="工具类StringUtil-java">工具类StringUtil.java</h2>
<p>这里给出SHA256算法使用方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密摘要</span></span><br><span class="line"><span class="comment">     * Applies Sha256 to a string and returns the result.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">applySha256</span><span class="params">(String input)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">digest</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">            <span class="comment">//Applies sha256 to our input,</span></span><br><span class="line">            <span class="type">byte</span>[] hash = digest.digest(input.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * This will contain hash as hexidecimal</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; hash.length; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> Integer.toHexString(<span class="number">0xff</span> &amp; hash[i]);</span><br><span class="line">                <span class="keyword">if</span>(hex.length() == <span class="number">1</span>) &#123;</span><br><span class="line">                    hexString.append(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                hexString.append(hex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> hexString.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Block</span> <span class="variable">genesisBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(), <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hash for block 1 : &quot;</span> + genesisBlock.hash);</span><br><span class="line"></span><br><span class="line">        <span class="type">Block</span> <span class="variable">secondBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(),genesisBlock.hash);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hash for block 2 : &quot;</span> + secondBlock.hash);</span><br><span class="line"></span><br><span class="line">        <span class="type">Block</span> <span class="variable">thirdBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(),secondBlock.hash);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hash for block 3 : &quot;</span> + thirdBlock.hash);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Hash for block 1 : 73e659c6ee17b83f0d3209097facb1fe32ba3f2f857a03329be5cac533c5b362</span><br><span class="line">Hash for block 2 : b608321771936423e99eeb93c74c524937131689f2a3d437891e2ecbd14ff404</span><br><span class="line">Hash for block 3 : 02dc6bd5f9e1e11058fd5622e8e1150cf7085ae32c7de879982bf3381a3ce8b7</span><br></pre></td></tr></table></figure>
<h2 id="使用Gson类输出json格式信息">使用Gson类输出json格式信息</h2>
<p>引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;gson&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.8.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>我们用ArrayList 将区块串起来，组成区块链</p>
<p>测试代码2：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">    ArrayList&lt;Block&gt; blockchain = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Block&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//add our blocks to the blockchain ArrayList:</span></span><br><span class="line">    blockchain.add(<span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(), <span class="string">&quot;0&quot;</span>));</span><br><span class="line">    blockchain.add(<span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(),blockchain.get(blockchain.size()-<span class="number">1</span>).hash));</span><br><span class="line">    blockchain.add(<span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(),blockchain.get(blockchain.size()-<span class="number">1</span>).hash));</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">blockchainJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GsonBuilder</span>().setPrettyPrinting().create().toJson(blockchain);</span><br><span class="line">    System.out.println(blockchainJson);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;index&quot;: 0,</span><br><span class="line">    &quot;hash&quot;: &quot;da5b9fb425a489c460488aeb4f7a0de0c8b81d4e87d0199af57932cc3cccb005&quot;,</span><br><span class="line">    &quot;previousHash&quot;: &quot;0&quot;,</span><br><span class="line">    &quot;data&quot;: [],</span><br><span class="line">    &quot;timeStamp&quot;: 1679820296791,</span><br><span class="line">    &quot;nonce&quot;: 0,</span><br><span class="line">    &quot;running&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;index&quot;: 1,</span><br><span class="line">    &quot;hash&quot;: &quot;1d4c0d0b25376d660e51d4a1cd3a5380a5e76bce0827fcf204bff9f4c0a53e10&quot;,</span><br><span class="line">    &quot;previousHash&quot;: &quot;da5b9fb425a489c460488aeb4f7a0de0c8b81d4e87d0199af57932cc3cccb005&quot;,</span><br><span class="line">    &quot;data&quot;: [],</span><br><span class="line">    &quot;timeStamp&quot;: 1679820296823,</span><br><span class="line">    &quot;nonce&quot;: 0,</span><br><span class="line">    &quot;running&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;index&quot;: 2,</span><br><span class="line">    &quot;hash&quot;: &quot;14dac1b905439bb19d639e094ea5858b26c7b186394194f542411314d877a0ad&quot;,</span><br><span class="line">    &quot;previousHash&quot;: &quot;1d4c0d0b25376d660e51d4a1cd3a5380a5e76bce0827fcf204bff9f4c0a53e10&quot;,</span><br><span class="line">    &quot;data&quot;: [],</span><br><span class="line">    &quot;timeStamp&quot;: 1679820296823,</span><br><span class="line">    &quot;nonce&quot;: 0,</span><br><span class="line">    &quot;running&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1>2.挖矿与验证</h1>
<p>首先遍历链条中每个区块与它上一个的区块，验证：</p>
<ol>
<li>验证当前区块是不是被修改过数据后上传，上传者可能只修改了当前的区块的数据而不会去重新生成哈希。</li>
<li>对比先前的区块哈希与当前区块里面链接的上一个区块的哈希是否一致</li>
<li>对比这个区块是不是达成工作量要求</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证这个区块的合法性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span>  Boolean <span class="title function_">isChainValid</span><span class="params">()</span> &#123;</span><br><span class="line">    Block currentBlock;</span><br><span class="line">    Block previousBlock;</span><br><span class="line">    <span class="type">String</span> <span class="variable">hashTarget</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[ difficulty]).replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//loop through blockchain to check hashes:</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i &lt;  serviceClient.blockchain.size(); i++) &#123;</span><br><span class="line">        currentBlock = serviceClient.blockchain.get(i);</span><br><span class="line">        previousBlock = serviceClient.blockchain.get(i-<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//compare registered hash and calculated hash:</span></span><br><span class="line">        <span class="keyword">if</span>(!currentBlock.hash.equals(currentBlock.calculateHash()) )&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Current Hashes not equal&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//compare previous hash and registered previous hash</span></span><br><span class="line">        <span class="keyword">if</span>(!previousBlock.hash.equals(currentBlock.previousHash) ) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Previous Hashes not equal&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//check if hash is solved</span></span><br><span class="line">        <span class="keyword">if</span>(!currentBlock.hash.substring( <span class="number">0</span>, difficulty).equals(hashTarget)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;This block hasn&#x27;t been mined&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ArrayList&lt;Block&gt; blockchain = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Block&gt;();</span><br><span class="line">    <span class="comment">//难度系数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">difficulty</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test03</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        blockchain.add(<span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(), <span class="string">&quot;0&quot;</span>));</span><br><span class="line">          System.out.println(<span class="string">&quot;Trying to Mine block 1... &quot;</span>);</span><br><span class="line">          blockchain.get(<span class="number">0</span>).mineBlock(difficulty);</span><br><span class="line"></span><br><span class="line">        blockchain.add(<span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(),blockchain.get(blockchain.size()-<span class="number">1</span>).hash));</span><br><span class="line">          System.out.println(<span class="string">&quot;Trying to Mine block 2... &quot;</span>);</span><br><span class="line">          blockchain.get(<span class="number">1</span>).mineBlock(difficulty);</span><br><span class="line"></span><br><span class="line">        blockchain.add(<span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(),blockchain.get(blockchain.size()-<span class="number">1</span>).hash));</span><br><span class="line">          System.out.println(<span class="string">&quot;Trying to Mine block 3... &quot;</span>);</span><br><span class="line">          blockchain.get(<span class="number">2</span>).mineBlock(difficulty);</span><br><span class="line"></span><br><span class="line">          System.out.println(<span class="string">&quot;\nBlockchain is Valid: &quot;</span> + isChainValid());</span><br><span class="line"></span><br><span class="line">          <span class="type">String</span> <span class="variable">blockchainJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GsonBuilder</span>().setPrettyPrinting().create().toJson(blockchain);</span><br><span class="line">          System.out.println(<span class="string">&quot;\nThe block chain: &quot;</span>);</span><br><span class="line">          System.out.println(blockchainJson);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证这个区块的合法性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  Boolean <span class="title function_">isChainValid</span><span class="params">()</span> &#123;</span><br><span class="line">        Block currentBlock;</span><br><span class="line">        Block previousBlock;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hashTarget</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[ difficulty]).replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//loop through blockchain to check hashes:</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i &lt;  blockchain.size(); i++) &#123;</span><br><span class="line">            currentBlock = blockchain.get(i);</span><br><span class="line">            previousBlock = blockchain.get(i-<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//compare registered hash and calculated hash:</span></span><br><span class="line">            <span class="keyword">if</span>(!currentBlock.hash.equals(currentBlock.calculateHash()) )&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Current Hashes not equal&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//compare previous hash and registered previous hash</span></span><br><span class="line">            <span class="keyword">if</span>(!previousBlock.hash.equals(currentBlock.previousHash) ) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Previous Hashes not equal&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//check if hash is solved</span></span><br><span class="line">            <span class="keyword">if</span>(!currentBlock.hash.substring( <span class="number">0</span>, difficulty).equals(hashTarget)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;This block hasn&#x27;t been mined&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Trying to Mine block 1... </span><br><span class="line">Block Mined!!! : 000cebc823ab29477def440c42e40cc8f2d6c95e9a70acaa194118b805fd3af0</span><br><span class="line">Trying to Mine block 2... </span><br><span class="line">Block Mined!!! : 000078bd7a30e9062e47040a0c2e41132e8d7f0cfbc7aca8bbc7dd402d0a7490</span><br><span class="line">Trying to Mine block 3... </span><br><span class="line">Block Mined!!! : 000f8c109c985348c4ed51f78405e2ddba8d365c14caf399cdd9e62f99566830</span><br><span class="line"></span><br><span class="line">Blockchain is Valid: true</span><br><span class="line"></span><br><span class="line">The block chain: </span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;index&quot;: 0,</span><br><span class="line">    &quot;hash&quot;: &quot;000cebc823ab29477def440c42e40cc8f2d6c95e9a70acaa194118b805fd3af0&quot;,</span><br><span class="line">    &quot;previousHash&quot;: &quot;0&quot;,</span><br><span class="line">    &quot;data&quot;: [],</span><br><span class="line">    &quot;timeStamp&quot;: 1679821998773,</span><br><span class="line">    &quot;nonce&quot;: 2695,</span><br><span class="line">    &quot;running&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;index&quot;: 1,</span><br><span class="line">    &quot;hash&quot;: &quot;000078bd7a30e9062e47040a0c2e41132e8d7f0cfbc7aca8bbc7dd402d0a7490&quot;,</span><br><span class="line">    &quot;previousHash&quot;: &quot;000cebc823ab29477def440c42e40cc8f2d6c95e9a70acaa194118b805fd3af0&quot;,</span><br><span class="line">    &quot;data&quot;: [],</span><br><span class="line">    &quot;timeStamp&quot;: 1679821998850,</span><br><span class="line">    &quot;nonce&quot;: 1692,</span><br><span class="line">    &quot;running&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;index&quot;: 2,</span><br><span class="line">    &quot;hash&quot;: &quot;000f8c109c985348c4ed51f78405e2ddba8d365c14caf399cdd9e62f99566830&quot;,</span><br><span class="line">    &quot;previousHash&quot;: &quot;000078bd7a30e9062e47040a0c2e41132e8d7f0cfbc7aca8bbc7dd402d0a7490&quot;,</span><br><span class="line">    &quot;data&quot;: [],</span><br><span class="line">    &quot;timeStamp&quot;: 1679821998871,</span><br><span class="line">    &quot;nonce&quot;: 3385,</span><br><span class="line">    &quot;running&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1>3.通信实现</h1>
<p>在网络的设计上，这里采用传统的CS模式来模拟两个点之间的网络行为，即特定客户端发送请求服务端，服务端回复。事实上P2P每个节点即是服务器也是客户端，而且后续改进可以从这里修改。</p>
<h2 id="1-使用WebSocket实现服务器和客户端的网络通信基础模块，引入依赖">1.使用WebSocket实现服务器和客户端的网络通信基础模块，引入依赖</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.java-websocket&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;Java-WebSocket&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.5.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h2 id="2-SocketServer-java">2.SocketServer.java</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.java_websocket.WebSocket;</span><br><span class="line"><span class="keyword">import</span> org.java_websocket.handshake.ClientHandshake;</span><br><span class="line"><span class="keyword">import</span> org.java_websocket.server.WebSocketServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@code</span> 网络模块 服务端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketServer</span> <span class="keyword">extends</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;WebSocket&gt; list;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SocketServer</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> UnknownHostException &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SocketServer</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(WebSocket conn, ClientHandshake handshake)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method sends a message to the new client</span></span><br><span class="line">        conn.send(<span class="string">&quot;Welcome to the server!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// This method sends a message to all clients connected</span></span><br><span class="line">        broadcast(conn.getRemoteSocketAddress().getAddress().getHostAddress() + <span class="string">&quot; entered the room!&quot;</span>);</span><br><span class="line">        System.out.println(conn.getRemoteSocketAddress().getAddress().getHostAddress() + <span class="string">&quot; entered the room!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        list.add(conn);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(WebSocket conn, <span class="type">int</span> code, String reason, <span class="type">boolean</span> remote)</span> &#123;</span><br><span class="line">        broadcast(conn + <span class="string">&quot; has left the room!&quot;</span>);</span><br><span class="line">        System.out.println(conn + <span class="string">&quot; has left the room!&quot;</span>);</span><br><span class="line">        list.remove(conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(WebSocket conn, String message)</span> &#123;</span><br><span class="line"></span><br><span class="line">        broadcast(conn + <span class="string">&quot;:&quot;</span> + message);</span><br><span class="line">        System.out.println(conn + <span class="string">&quot;: &quot;</span> + message + <span class="string">&quot;，修改前。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(WebSocket conn, Exception ex)</span> &#123;</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (conn != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// some errors like port binding failed may not be assignable to a specific</span></span><br><span class="line">            <span class="comment">// websocket</span></span><br><span class="line">            broadcast(conn + <span class="string">&quot;has a error! it will be quit!&quot;</span>);</span><br><span class="line">            list.remove(conn);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Server started!&quot;</span>);</span><br><span class="line">        setConnectionLostTimeout(<span class="number">0</span>);</span><br><span class="line">        setConnectionLostTimeout(<span class="number">100</span>);</span><br><span class="line">        list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">MsgBroadcast</span><span class="params">(String msg)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(msg != <span class="literal">null</span> &amp;&amp; list.size() &gt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            broadcast(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-socketClient-java">3.socketClient.java</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.java_websocket.WebSocket;</span><br><span class="line"><span class="keyword">import</span> org.java_websocket.client.WebSocketClient;</span><br><span class="line"><span class="keyword">import</span> org.java_websocket.drafts.Draft;</span><br><span class="line"><span class="keyword">import</span> org.java_websocket.handshake.ServerHandshake;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@code</span> 网络模块，客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketClient</span> <span class="keyword">extends</span> <span class="title class_">WebSocketClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;WebSocket&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;WebSocket&gt; <span class="title function_">getList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setList</span><span class="params">(List&lt;WebSocket&gt; list)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SocketClient</span><span class="params">(URI serverUri)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serverUri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SocketClient</span><span class="params">(URI serverUri, Draft protocolDraft)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serverUri, protocolDraft);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(ServerHandshake serverHandshake)</span> &#123;</span><br><span class="line">        list.add(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="type">int</span> i, String s, <span class="type">boolean</span> b)</span> &#123;</span><br><span class="line">        list.remove(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        list.remove(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String msg)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(msg != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.send(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">server</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">SocketServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SocketServer</span>(port);</span><br><span class="line">        server.start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">String</span> <span class="variable">wait</span> <span class="operator">=</span> scanner.nextLine();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  ws://localhost:8888</span></span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">client</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">SocketClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client = <span class="keyword">new</span> <span class="title class_">SocketClient</span>(<span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;ws://localhost:8888&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        client.connect();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>使用<a target="_blank" rel="noopener" href="http://coolaf.com/tool/chattest">http://coolaf.com/tool/chattest</a> 测试服务端是否开启成功 <code>ws://localhost:8888</code></p>
<p>打印：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Server started!</span><br><span class="line">0:0:0:0:0:0:0:1 entered the room!</span><br><span class="line">127.0.0.1 entered the room!</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the server!</span><br><span class="line">127.0.0.1 entered the room!</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">连接成功，现在你可以发送信息啦！！！</span><br><span class="line">服务端回应 2023-03-26 17:30:31</span><br><span class="line">Welcome to the server!</span><br><span class="line">服务端回应 2023-03-26 17:30:31</span><br><span class="line">0:0:0:0:0:0:0:1 entered the room!</span><br><span class="line">服务端回应 2023-03-26 17:33:25</span><br><span class="line">127.0.0.1 entered the room!</span><br><span class="line">websocket连接已断开!!!</span><br></pre></td></tr></table></figure>
<h1>4.网络服务实现</h1>
<h2 id="1-消息实现">1.消息实现</h2>
<p>首先需要对消息进行定义处理，例如A节点对B节点发送区块链更新请求消息，或者是C节点挖到一个矿，想要对其进行广播，其他节点收到消息会对其进行处理。</p>
<p>定义消息模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> type;</span><br><span class="line">    <span class="keyword">private</span> String data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(<span class="type">int</span> type, String data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setType</span><span class="params">(<span class="type">int</span> type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义消息类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Network: BLOCK_PROTOCOL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlockConstant</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">QUERY_LATEST_BLOCK</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">QUERY_BLOCKCHAIN</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">QUERY_LATEST_TRANSACTION</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">UPLOAD_MINED_BLOCK</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">RETURN_LATEST_BLOCK</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">RETURN_BLOCKCHAIN</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  &lt;T&gt; T <span class="title function_">simpleJsonToObj</span><span class="params">(String json, Class&lt;T&gt; cls)</span> &#123;</span><br><span class="line">        <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(json)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> gson.fromJson(json, cls);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(obj)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> obj;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">simpleObjToJson</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(obj)) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line">            <span class="keyword">return</span> gson.toJson(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-定义接口">2.定义接口</h2>
<p>节点通用的方法</p>
<p>定义节点接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传增加一个或一条链</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IBroadcastBlock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加一个区块</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> added result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">broadcastBlock</span><span class="params">(String msg)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IQueryBlock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询区块</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">queryBlockFromOthers</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Block <span class="title function_">queryBlockFromLocal</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询链</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">queryChainFromLocal</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">queryChainFromOthers</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证一个或一条链</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IVerifyBlock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证该区块是否有问题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> block 需要验证的区块</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 0:该块通过，</span></span><br><span class="line"><span class="comment">     *          1:该链有结构问题</span></span><br><span class="line"><span class="comment">     *          2:该链数字摘要修改过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">verifyBlock</span><span class="params">(String block)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证该区块链是否有问题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain 需要验证的链</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 0，通过 ，1不通过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">verifyChain</span><span class="params">(String chain)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-实现简易消息处理的服务端">3.实现简易消息处理的服务端</h2>
<p>首先，对SocketServer的onMessage进行重写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                server = <span class="keyword">new</span> <span class="title class_">SocketServer</span>(port)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(WebSocket conn, String message)</span></span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    handleMessage(conn,message);</span><br><span class="line"></span><br><span class="line"><span class="comment">//                    broadcast(conn + &quot;:&quot; + message);</span></span><br><span class="line"><span class="comment">//                    System.out.println(conn + &quot;: &quot; + message + &quot;，修改后。&quot;);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br></pre></td></tr></table></figure>
<p>其次，定义消息接收后的处理方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(WebSocket conn, String message)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> simpleJsonToObj(message,Message.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (msg.getType())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> QUERY_LATEST_BLOCK:</span><br><span class="line">            <span class="type">Message</span> <span class="variable">queryBlockMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(RETURN_LATEST_BLOCK, simpleObjToJson(queryBlockFromLocal()));</span><br><span class="line">            <span class="type">String</span> <span class="variable">sendBlockMsg</span>  <span class="operator">=</span> simpleObjToJson(queryBlockMsg);</span><br><span class="line">            conn.send(sendBlockMsg);</span><br><span class="line"></span><br><span class="line">            System.out.println(conn.getRemoteSocketAddress() + <span class="string">&quot;,queryBLOCK:&quot;</span>+ queryBlockMsg.getData());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> QUERY_BLOCKCHAIN:</span><br><span class="line">            <span class="type">Message</span> <span class="variable">queryChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(RETURN_BLOCKCHAIN, queryChainFromLocal());</span><br><span class="line">            <span class="type">String</span> <span class="variable">sendChain</span>  <span class="operator">=</span> simpleObjToJson(queryChain);</span><br><span class="line">            conn.send(sendChain);</span><br><span class="line"></span><br><span class="line">            System.out.println(conn.getRemoteSocketAddress() +<span class="string">&quot;: QUERY_BLOCK_CHAIN:&quot;</span>+ queryChain.getData());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> QUERY_LATEST_TRANSACTION:</span><br><span class="line">            server.broadcast(<span class="string">&quot;TRANSACTION:&quot;</span> + msg.getData());</span><br><span class="line">            System.out.println(<span class="string">&quot;TRANSACTION:&quot;</span> + msg.getData());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> UPLOAD_MINED_BLOCK:</span><br><span class="line"></span><br><span class="line">            <span class="type">Block</span> <span class="variable">mineBlock</span> <span class="operator">=</span> simpleJsonToObj(msg.getData(),Block.class);</span><br><span class="line">            blockchain.add(mineBlock);</span><br><span class="line">            <span class="keyword">if</span>(!isChainValid())</span><br><span class="line">            &#123;</span><br><span class="line">                blockchain.removeLast();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                server.broadcast(message);</span><br><span class="line">                System.out.println(message);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> RETURN_LATEST_BLOCK:</span><br><span class="line">            <span class="type">Block</span> <span class="variable">b</span> <span class="operator">=</span> simpleJsonToObj(msg.getData(),Block.class);</span><br><span class="line">            blockchain.add(b);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;got the latest block! &quot;</span> + queryBlockFromLocal().hash);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RETURN_BLOCKCHAIN:</span><br><span class="line">            <span class="comment">//server.broadcast(&quot;DOWNLOAD_BLOCKCHAIN:&quot;+ msg.getData());</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//System.out.println(&quot;DOWNLOAD_BLOCKCHAIN:&quot;+ msg.getData());</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//System.out.println(msg);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整代码ServiceServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.giyaYon.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Blocks.Block;</span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Network.Message;</span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Network.SocketServer;</span><br><span class="line"><span class="keyword">import</span> org.java_websocket.WebSocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Network.BlockConstant.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Service.ServiceClient.difficulty;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceServer</span> <span class="keyword">implements</span> <span class="title class_">IQueryBlock</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通信服务器</span></span><br><span class="line">    SocketServer server;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启端口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//账本</span></span><br><span class="line">    LinkedList&lt;Block&gt; blockchain = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Block&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceServer</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runServer</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">                server = <span class="keyword">new</span> <span class="title class_">SocketServer</span>(port)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(WebSocket conn, String message)</span></span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    handleMessage(conn,message);</span><br><span class="line"></span><br><span class="line"><span class="comment">//                    broadcast(conn + &quot;:&quot; + message);</span></span><br><span class="line"><span class="comment">//                    System.out.println(conn + &quot;: &quot; + message + &quot;，修改后。&quot;);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            server.start();</span><br><span class="line">            System.out.println(<span class="string">&quot;ChatServer started on port: &quot;</span> + server.getPort());</span><br><span class="line"></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">sysin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in));</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">in</span> <span class="operator">=</span> sysin.readLine();</span><br><span class="line">                <span class="comment">//s.broadcast(in);</span></span><br><span class="line">                <span class="keyword">if</span> (in.equals(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">                    server.stop(<span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(WebSocket conn, String message)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> simpleJsonToObj(message,Message.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (msg.getType())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> QUERY_LATEST_BLOCK:</span><br><span class="line">                <span class="type">Message</span> <span class="variable">queryBlockMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(RETURN_LATEST_BLOCK, simpleObjToJson(queryBlockFromLocal()));</span><br><span class="line">                <span class="type">String</span> <span class="variable">sendBlockMsg</span>  <span class="operator">=</span> simpleObjToJson(queryBlockMsg);</span><br><span class="line">                conn.send(sendBlockMsg);</span><br><span class="line"></span><br><span class="line">                System.out.println(conn.getRemoteSocketAddress() + <span class="string">&quot;,queryBLOCK:&quot;</span>+ queryBlockMsg.getData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> QUERY_BLOCKCHAIN:</span><br><span class="line">                <span class="type">Message</span> <span class="variable">queryChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(RETURN_BLOCKCHAIN, queryChainFromLocal());</span><br><span class="line">                <span class="type">String</span> <span class="variable">sendChain</span>  <span class="operator">=</span> simpleObjToJson(queryChain);</span><br><span class="line">                conn.send(sendChain);</span><br><span class="line"></span><br><span class="line">                System.out.println(conn.getRemoteSocketAddress() +<span class="string">&quot;: QUERY_BLOCK_CHAIN:&quot;</span>+ queryChain.getData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> QUERY_LATEST_TRANSACTION:</span><br><span class="line">                server.broadcast(<span class="string">&quot;TRANSACTION:&quot;</span> + msg.getData());</span><br><span class="line">                System.out.println(<span class="string">&quot;TRANSACTION:&quot;</span> + msg.getData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> UPLOAD_MINED_BLOCK:</span><br><span class="line"></span><br><span class="line">                <span class="type">Block</span> <span class="variable">mineBlock</span> <span class="operator">=</span> simpleJsonToObj(msg.getData(),Block.class);</span><br><span class="line">                blockchain.add(mineBlock);</span><br><span class="line">                <span class="keyword">if</span>(!isChainValid())</span><br><span class="line">                &#123;</span><br><span class="line">                    blockchain.removeLast();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    server.broadcast(message);</span><br><span class="line">                    System.out.println(message);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> RETURN_LATEST_BLOCK:</span><br><span class="line">                <span class="type">Block</span> <span class="variable">b</span> <span class="operator">=</span> simpleJsonToObj(msg.getData(),Block.class);</span><br><span class="line">                blockchain.add(b);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">&quot;got the latest block! &quot;</span> + queryBlockFromLocal().hash);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RETURN_BLOCKCHAIN:</span><br><span class="line">                <span class="comment">//server.broadcast(&quot;DOWNLOAD_BLOCKCHAIN:&quot;+ msg.getData());</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//System.out.println(&quot;DOWNLOAD_BLOCKCHAIN:&quot;+ msg.getData());</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//System.out.println(msg);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryBlockFromOthers</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        Message queryBlock = new Message(QUERY_LATEST_BLOCK,&quot;&quot;);</span></span><br><span class="line"><span class="comment">//        String msg = simpleObjToJson(queryBlock);</span></span><br><span class="line"><span class="comment">//        server.sendMessage(msg);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Block <span class="title function_">queryBlockFromLocal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> blockchain.getLast();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">queryChainFromLocal</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Block&gt; iterator = blockchain.iterator();</span><br><span class="line">        Block block;</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">            block = iterator.next();</span><br><span class="line">            list.append(simpleObjToJson(block));</span><br><span class="line">            list.append(<span class="string">&quot;|&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (list.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            list.deleteCharAt(list.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryChainFromOthers</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  Boolean <span class="title function_">isChainValid</span><span class="params">()</span> &#123;</span><br><span class="line">        Block currentBlock;</span><br><span class="line">        Block previousBlock;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hashTarget</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[ difficulty]).replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//loop through blockchain to check hashes:</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i &lt;  blockchain.size(); i++) &#123;</span><br><span class="line">            currentBlock = blockchain.get(i);</span><br><span class="line">            previousBlock = blockchain.get(i-<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//compare registered hash and calculated hash:</span></span><br><span class="line">            <span class="keyword">if</span>(!currentBlock.hash.equals(currentBlock.calculateHash()) )&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Current Hashes not equal&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//compare previous hash and registered previous hash</span></span><br><span class="line">            <span class="keyword">if</span>(!previousBlock.hash.equals(currentBlock.previousHash) ) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Previous Hashes not equal&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//check if hash is solved</span></span><br><span class="line">            <span class="keyword">if</span>(!currentBlock.hash.substring( <span class="number">0</span>, difficulty).equals(hashTarget)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;This block hasn&#x27;t been mined&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-实现客户端">4.实现客户端</h2>
<p>客户端实现包括两个，第一是被动的网络服务，第二是用户行为主动服务</p>
<p>1.网络服务ConnectService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.giyaYon.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Blocks.Block;</span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Network.Message;</span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Network.SocketClient;</span><br><span class="line"><span class="keyword">import</span> org.java_websocket.WebSocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Network.BlockConstant.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Service.ServiceClient.difficulty;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Service.StateConstant.*;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统被动型服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectService</span> <span class="keyword">implements</span> <span class="title class_">IBroadcastBlock</span>,IVerifyBlock,IQueryBlock &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ServiceClient serviceClient;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * for communication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> SocketClient client;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectService</span><span class="params">(String url,ServiceClient serviceClient)</span> <span class="keyword">throws</span> URISyntaxException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.serviceClient = serviceClient;</span><br><span class="line">        client = <span class="keyword">new</span> <span class="title class_">SocketClient</span>(<span class="keyword">new</span> <span class="title class_">URI</span>(url))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String s)</span></span><br><span class="line">            &#123;</span><br><span class="line">                handleMessage(client,s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SocketClient <span class="title function_">getClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启联网</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startService</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        client.connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopService</span><span class="params">()</span>&#123;client.close();&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(WebSocket conn, String message)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> simpleJsonToObj(message,Message.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (msg.getType())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//请求查询当前最新区块</span></span><br><span class="line">            <span class="keyword">case</span> QUERY_LATEST_BLOCK:</span><br><span class="line">                <span class="type">Message</span> <span class="variable">queryBlockMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(RETURN_LATEST_BLOCK, simpleObjToJson(queryBlockFromLocal()));</span><br><span class="line">                <span class="type">String</span> <span class="variable">sendBlockMsg</span>  <span class="operator">=</span> simpleObjToJson(queryBlockMsg);</span><br><span class="line">                conn.send(sendBlockMsg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//请求查询最新区块链</span></span><br><span class="line">            <span class="keyword">case</span> QUERY_BLOCKCHAIN:</span><br><span class="line">                <span class="type">Message</span> <span class="variable">queryChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(RETURN_BLOCKCHAIN, queryChainFromLocal());</span><br><span class="line">                <span class="type">String</span> <span class="variable">sendChain</span>  <span class="operator">=</span> simpleObjToJson(queryChain);</span><br><span class="line">                conn.send(sendChain);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//TODO 请求查询最新交易池</span></span><br><span class="line">            <span class="keyword">case</span> QUERY_LATEST_TRANSACTION:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 上传挖矿块</span></span><br><span class="line">            <span class="keyword">case</span> UPLOAD_MINED_BLOCK:</span><br><span class="line"></span><br><span class="line">                <span class="comment">//解析消息</span></span><br><span class="line">                <span class="type">Block</span> <span class="variable">mineBlock</span> <span class="operator">=</span> simpleJsonToObj(msg.getData(),Block.class);</span><br><span class="line">                <span class="comment">//加入本账本</span></span><br><span class="line">                ServiceClient.blockchain.add(mineBlock);</span><br><span class="line">                <span class="comment">//验证合法性，若不正确就删除这个最新的区块</span></span><br><span class="line">                <span class="keyword">if</span>(!isChainValid())</span><br><span class="line">                &#123;</span><br><span class="line">                    ServiceClient.blockchain.removeLast();</span><br><span class="line">                    System.out.println(<span class="string">&quot;had removed the block&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="type">Block</span> <span class="variable">latestBlock</span> <span class="operator">=</span> queryBlockFromLocal();</span><br><span class="line">                    System.out.println(<span class="string">&quot;i received the new block:&quot;</span> + latestBlock.toString());</span><br><span class="line">                    <span class="comment">//收到新的区块，如果用户仍在挖矿，则看看它挖的是不是重复的区块，是的话就提示他停下来了</span></span><br><span class="line">                    <span class="keyword">if</span>(serviceClient.userService.state.getType() == MINEING)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span>(Integer.parseInt(serviceClient.userService.state.getData()) == latestBlock.index)</span><br><span class="line">                        &#123;</span><br><span class="line">                            serviceClient.userService.stopToMineBlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 返回最新区块</span></span><br><span class="line">            <span class="keyword">case</span> RETURN_LATEST_BLOCK:</span><br><span class="line">                <span class="type">Block</span> <span class="variable">b</span> <span class="operator">=</span> simpleJsonToObj(msg.getData(), Block.class);</span><br><span class="line">                serviceClient.blockchain.add(b);</span><br><span class="line">                <span class="keyword">if</span>(!isChainValid())</span><br><span class="line">                &#123;</span><br><span class="line">                    ServiceClient.blockchain.removeLast();</span><br><span class="line">                    System.out.println(<span class="string">&quot;had removed the block&quot;</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">Block</span> <span class="variable">latestBlock</span> <span class="operator">=</span> queryBlockFromLocal();</span><br><span class="line">                    System.out.println(<span class="string">&quot;your local latest block is:&quot;</span> + latestBlock.hash);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//TODO 返回最新的区块链</span></span><br><span class="line">            <span class="keyword">case</span> RETURN_BLOCKCHAIN:</span><br><span class="line">                serviceClient.blockchain.clear();</span><br><span class="line">                String[] chain = msg.getData().split(<span class="string">&quot;\\|&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (String s : chain) &#123;</span><br><span class="line">                    <span class="type">Block</span> <span class="variable">block</span> <span class="operator">=</span> simpleJsonToObj(s,Block.class);</span><br><span class="line">                    serviceClient.blockchain.add(block);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Block block :ServiceClient.blockchain)</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(block.toString());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//System.out.println(msg);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">verifyBlock</span><span class="params">(String block)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">verifyChain</span><span class="params">(String chain)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">broadcastBlock</span><span class="params">(String msg)</span> &#123;</span><br><span class="line"></span><br><span class="line">        client.sendMessage(msg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryBlockFromOthers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">queryBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(QUERY_LATEST_BLOCK,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> simpleObjToJson(queryBlock);</span><br><span class="line">        client.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Block <span class="title function_">queryBlockFromLocal</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> serviceClient.blockchain.getLast();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">queryChainFromLocal</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Block&gt; iterator = serviceClient. blockchain.iterator();</span><br><span class="line">        Block block;</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">            block = iterator.next();</span><br><span class="line">            list.append(simpleObjToJson(block));</span><br><span class="line">            list.append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (list.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            list.deleteCharAt(list.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryChainFromOthers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">queryBlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(QUERY_BLOCKCHAIN,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> simpleObjToJson(queryBlock);</span><br><span class="line">        client.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证这个区块的合法性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  Boolean <span class="title function_">isChainValid</span><span class="params">()</span> &#123;</span><br><span class="line">        Block currentBlock;</span><br><span class="line">        Block previousBlock;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hashTarget</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[ difficulty]).replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//loop through blockchain to check hashes:</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i &lt;  serviceClient.blockchain.size(); i++) &#123;</span><br><span class="line">            currentBlock = serviceClient.blockchain.get(i);</span><br><span class="line">            previousBlock = serviceClient.blockchain.get(i-<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//compare registered hash and calculated hash:</span></span><br><span class="line">            <span class="keyword">if</span>(!currentBlock.hash.equals(currentBlock.calculateHash()) )&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Current Hashes not equal&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//compare previous hash and registered previous hash</span></span><br><span class="line">            <span class="keyword">if</span>(!previousBlock.hash.equals(currentBlock.previousHash) ) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Previous Hashes not equal&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//check if hash is solved</span></span><br><span class="line">            <span class="keyword">if</span>(!currentBlock.hash.substring( <span class="number">0</span>, difficulty).equals(hashTarget)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;This block hasn&#x27;t been mined&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.用户服务UserService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.giyaYon.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Blocks.Block;</span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Network.Message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Network.BlockConstant.UPLOAD_MINED_BLOCK;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Network.BlockConstant.simpleObjToJson;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.giyaYon.Service.StateConstant.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户主动型服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    ServiceClient serviceClient;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该客户端正在干什么</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Message state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Block currentMineBlock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(ServiceClient serviceClient)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.serviceClient = serviceClient;</span><br><span class="line">        state = <span class="keyword">new</span> <span class="title class_">Message</span>(IDLE,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 挖矿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryToMineBlock</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保持联网状态挖矿</span></span><br><span class="line">        <span class="keyword">if</span>(serviceClient.connection.client.isClosed()) &#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="keyword">if</span>(serviceClient.connection.client.isClosing()) &#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="keyword">if</span>(state.getType() != IDLE)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始挖矿</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> ServiceClient.blockchain.size();</span><br><span class="line">        <span class="keyword">if</span> (ServiceClient.blockchain.size() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//定义正在挖矿的状态</span></span><br><span class="line">            state = <span class="keyword">new</span> <span class="title class_">Message</span>(MINEING, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">            <span class="comment">//开挖</span></span><br><span class="line">            currentMineBlock = <span class="keyword">new</span> <span class="title class_">Block</span>(<span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(), <span class="string">&quot;0&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">broadcastNewBlockHash</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">//模拟矿工挖矿过程</span></span><br><span class="line">            broadcastNewBlockHash = currentMineBlock.mineBlock(ServiceClient.difficulty);</span><br><span class="line">            <span class="comment">//如果为空则会自动抛弃这个矿不会广播</span></span><br><span class="line">            <span class="keyword">if</span>(broadcastNewBlockHash != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;第0个！&quot;</span> + broadcastNewBlockHash);</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(UPLOAD_MINED_BLOCK, simpleObjToJson(currentMineBlock));</span><br><span class="line">                <span class="type">String</span> <span class="variable">broadcastBlock</span> <span class="operator">=</span> simpleObjToJson(msg);</span><br><span class="line">                <span class="comment">//将挖到的区块广播出去</span></span><br><span class="line">                serviceClient.connection.broadcastBlock(broadcastBlock);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//非创世矿挖矿</span></span><br><span class="line">            state = <span class="keyword">new</span> <span class="title class_">Message</span>(MINEING, String.valueOf(index));</span><br><span class="line">            <span class="comment">//开挖</span></span><br><span class="line">            currentMineBlock = <span class="keyword">new</span> <span class="title class_">Block</span>(index, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(), ServiceClient.blockchain.get(ServiceClient.blockchain.size() - <span class="number">1</span>).hash);</span><br><span class="line">            <span class="type">String</span> <span class="variable">broadcastNewBlockHash</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            broadcastNewBlockHash = currentMineBlock.mineBlock(ServiceClient.difficulty);</span><br><span class="line">            <span class="keyword">if</span>(broadcastNewBlockHash != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;第&quot;</span> + index + <span class="string">&quot;个！&quot;</span> + broadcastNewBlockHash);</span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(UPLOAD_MINED_BLOCK, simpleObjToJson(currentMineBlock));</span><br><span class="line">                <span class="type">String</span> <span class="variable">broadcastBlock</span> <span class="operator">=</span> simpleObjToJson(msg);</span><br><span class="line">                <span class="comment">//将挖到的区块广播出去</span></span><br><span class="line">                serviceClient.connection.broadcastBlock(broadcastBlock);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        state = <span class="keyword">new</span> <span class="title class_">Message</span>(IDLE, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopToMineBlock</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        currentMineBlock.stopMining();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对两个服务进行整合 ServiceClient.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.giyaYon.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Blocks.Block;</span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Blocks.TransactionData;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> GiyaYon</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@code</span> 服务层 网络同步区块服务模块</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 开启服务</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * //接口</span></span><br><span class="line"><span class="comment"> * 发送一个区块</span></span><br><span class="line"><span class="comment"> * 发送一个链</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 验证一个区块</span></span><br><span class="line"><span class="comment"> * 验证一个链</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 查看当前最新链</span></span><br><span class="line"><span class="comment"> * 查看整个链</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceClient</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  receive blockchain from others 区块链数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LinkedList&lt;Block&gt; blockchain = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Block&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  receive difficulty form others 定义工作量难度由区块链协议定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">difficulty</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  交易池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> LinkedList&lt;TransactionData&gt; transactions;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要先开启联网服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ConnectService connection;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 后续的挖矿等服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> UserService userService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceClient</span><span class="params">(String url)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            connection = <span class="keyword">new</span> <span class="title class_">ConnectService</span>(url,<span class="built_in">this</span>);</span><br><span class="line">            userService = <span class="keyword">new</span> <span class="title class_">UserService</span>(<span class="built_in">this</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runClientServer</span><span class="params">()</span>&#123;</span><br><span class="line">        connection.startService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exitClientServer</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        connection.stopService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test05</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ServiceServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceServer</span>(<span class="number">8888</span>);</span><br><span class="line">    server.runServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.giyaYon.Appliaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Service.ServiceClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientProgarm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> URISyntaxException, IOException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">peer</span> <span class="operator">=</span> <span class="string">&quot;ws://localhost:8888&quot;</span>;</span><br><span class="line">        <span class="type">ServiceClient</span> <span class="variable">serviceClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceClient</span>(peer);</span><br><span class="line">        serviceClient.runClientServer();</span><br><span class="line"></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                            ===================================</span></span><br><span class="line"><span class="string">                            please typing code what you want to do:</span></span><br><span class="line"><span class="string">                            1.exit system</span></span><br><span class="line"><span class="string">                            2.mine block</span></span><br><span class="line"><span class="string">                            3.update_block</span></span><br><span class="line"><span class="string">                            ===================================</span></span><br><span class="line"><span class="string">                            &quot;&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (scan.hasNext()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> scan.next();</span><br><span class="line">                <span class="keyword">if</span>(str1.equals(<span class="string">&quot;1&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;exiting...&quot;</span>);</span><br><span class="line">                    scan.close();</span><br><span class="line">                    serviceClient.exitClientServer();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(str1.equals(<span class="string">&quot;2&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;try to mine block...&quot;</span>);</span><br><span class="line">                    serviceClient.userService.tryToMineBlock();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(str1.equals(<span class="string">&quot;3&quot;</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    serviceClient.connection.queryChainFromOthers();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//serviceClient.userService.tryToMineBlock();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        Thread.sleep(100);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        serviceClient.userService.tryToMineBlock();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印：</p>
<p>打开服务端：</p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ChatServer started on port: 8888</span><br><span class="line">Server started!</span><br><span class="line">127.0.0.1 entered the room!</span><br><span class="line">&#123;&quot;type&quot;:4,&quot;data&quot;:&quot;&#123;\&quot;index\&quot;:0,\&quot;hash\&quot;:\&quot;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39\&quot;,\&quot;previousHash\&quot;:\&quot;0\&quot;,\&quot;data\&quot;:[],\&quot;timeStamp\&quot;:1679825452774,\&quot;nonce\&quot;:1769903,\&quot;running\&quot;:true&#125;&quot;&#125;</span><br><span class="line">&#123;&quot;type&quot;:4,&quot;data&quot;:&quot;&#123;\&quot;index\&quot;:1,\&quot;hash\&quot;:\&quot;0000004fd1849958d1cc5045b41f6bda486e2ab6b0fc69211a2e6de1254027c8\&quot;,\&quot;previousHash\&quot;:\&quot;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39\&quot;,\&quot;data\&quot;:[],\&quot;timeStamp\&quot;:1679825465536,\&quot;nonce\&quot;:8809650,\&quot;running\&quot;:true&#125;&quot;&#125;</span><br><span class="line">/127.0.0.1:8738: QUERY_BLOCK_CHAIN:&#123;&quot;index&quot;:0,&quot;hash&quot;:&quot;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&quot;,&quot;previousHash&quot;:&quot;0&quot;,&quot;data&quot;:[],&quot;timeStamp&quot;:1679825452774,&quot;nonce&quot;:1769903,&quot;running&quot;:true&#125;|&#123;&quot;index&quot;:1,&quot;hash&quot;:&quot;0000004fd1849958d1cc5045b41f6bda486e2ab6b0fc69211a2e6de1254027c8&quot;,&quot;previousHash&quot;:&quot;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&quot;,&quot;data&quot;:[],&quot;timeStamp&quot;:1679825465536,&quot;nonce&quot;:8809650,&quot;running&quot;:true&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>打开客户端A：</p>
<hr>
<p>我们打开客户端A后，默认已经进入服务器内部，我们开始输入2开始挖矿，我们挖两次矿后，输入3查询当前区块链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">===================================</span><br><span class="line">please typing code what you want to do:</span><br><span class="line">1.exit system</span><br><span class="line">2.mine block</span><br><span class="line">3.update_block</span><br><span class="line">===================================</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">try to mine block...</span><br><span class="line">Block Mined!!! : 000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39</span><br><span class="line">��0����000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39</span><br><span class="line">===================================</span><br><span class="line">please typing code what you want to do:</span><br><span class="line">1.exit system</span><br><span class="line">2.mine block</span><br><span class="line">3.update_block</span><br><span class="line">===================================</span><br><span class="line"></span><br><span class="line">i received the new block:Block&#123;index=0, hash=&#x27;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&#x27;, previousHash=&#x27;0&#x27;, data=[], timeStamp=1679825452774, nonce=1769903&#125;</span><br><span class="line">2</span><br><span class="line">try to mine block...</span><br><span class="line">Block Mined!!! : 0000004fd1849958d1cc5045b41f6bda486e2ab6b0fc69211a2e6de1254027c8</span><br><span class="line">��1����0000004fd1849958d1cc5045b41f6bda486e2ab6b0fc69211a2e6de1254027c8</span><br><span class="line">===================================</span><br><span class="line">please typing code what you want to do:</span><br><span class="line">1.exit system</span><br><span class="line">2.mine block</span><br><span class="line">3.update_block</span><br><span class="line">===================================</span><br><span class="line"></span><br><span class="line">i received the new block:Block&#123;index=1, hash=&#x27;0000004fd1849958d1cc5045b41f6bda486e2ab6b0fc69211a2e6de1254027c8&#x27;, previousHash=&#x27;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&#x27;, data=[], timeStamp=1679825465536, nonce=8809650&#125;</span><br><span class="line">3</span><br><span class="line">===================================</span><br><span class="line">please typing code what you want to do:</span><br><span class="line">1.exit system</span><br><span class="line">2.mine block</span><br><span class="line">3.update_block</span><br><span class="line">===================================</span><br><span class="line"></span><br><span class="line">Block&#123;index=0, hash=&#x27;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&#x27;, previousHash=&#x27;0&#x27;, data=[], timeStamp=1679825452774, nonce=1769903&#125;</span><br><span class="line">Block&#123;index=1, hash=&#x27;0000004fd1849958d1cc5045b41f6bda486e2ab6b0fc69211a2e6de1254027c8&#x27;, previousHash=&#x27;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&#x27;, data=[], timeStamp=1679825465536, nonce=8809650&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>客户端B：</p>
<hr>
<p>这里我们等待客户端A挖完矿之后，连接进入服务器，直接输入3获取当前区块链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">===================================</span><br><span class="line">please typing code what you want to do:</span><br><span class="line">1.exit system</span><br><span class="line">2.mine block</span><br><span class="line">3.update_block</span><br><span class="line">===================================</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">===================================</span><br><span class="line">please typing code what you want to do:</span><br><span class="line">1.exit system</span><br><span class="line">2.mine block</span><br><span class="line">3.update_block</span><br><span class="line">===================================</span><br><span class="line"></span><br><span class="line">Block&#123;index=0, hash=&#x27;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&#x27;, previousHash=&#x27;0&#x27;, data=[], timeStamp=1679825452774, nonce=1769903&#125;</span><br><span class="line">Block&#123;index=1, hash=&#x27;0000004fd1849958d1cc5045b41f6bda486e2ab6b0fc69211a2e6de1254027c8&#x27;, previousHash=&#x27;000000c257847251e823c5148046dec1bd0fbdf5aa6d1ecb8d5eba22fd217d39&#x27;, data=[], timeStamp=1679825465536, nonce=8809650&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1>5.实现Web API查询服务</h1>
<p>1.需要引入JAVA EE Web框架</p>
<p>2.需要部署Tomcat服务器</p>
<p>3.需要检查是否引入jar包到Web-INF 的lib</p>
<p>4.使用运行之前需要打开ServiceServer 、ServiceClient，并且让ServiceClient挖好矿之后再进行查询测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.giyaYon.Network;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.giyaYon.Service.ServiceClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.text.StringEscapeUtils;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@javax</span>.servlet.annotation.WebServlet(<span class="string">&quot;/hello&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">peer</span> <span class="operator">=</span> <span class="string">&quot;ws://localhost:8888&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">ServiceClient</span> <span class="variable">serviceClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceClient</span>(peer);</span><br><span class="line">        serviceClient.runClientServer();</span><br><span class="line">        serviceClient.connection.queryChainFromOthers();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">blocks</span> <span class="operator">=</span> serviceClient.connection.queryChainFromLocal();</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line"></span><br><span class="line">        out.println(<span class="string">&quot;&lt;p&gt;&quot;</span>+ blocks +<span class="string">&quot;&lt;/p&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serviceClient.exitClientServer();</span><br><span class="line"></span><br><span class="line">        System.out.println(blocks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<p>在localhost:8080/CoinBlock_war_exploded/ 后面输入hello</p>
<img src="https://raw.githubusercontent.com/GiyaYon/mypicGo/master/api.png" style="zoom:80%;" />
<h1>后言</h1>
<p><strong>Author:</strong> <a href="mailto:undefined">GiyaYon</a></p>
<p><strong>Copyright Notice:</strong> All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</p>
<p>后续将扩充交易信息内容模块，针对交易过程，设计Web电子商务系统，完善整个区块链系统。</p>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/helloworld2018/p/9011369.html">https://www.cnblogs.com/helloworld2018/p/9011369.html</a> java开发区块链只需150行代码 /<a target="_blank" rel="noopener" href="https://home.cnblogs.com/u/helloworld2018/">以太坊开发</a>/2018-07-19</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1776246">https://cloud.tencent.com/developer/article/1776246</a> 基于Java开发一套完整的区块链系统（附源码）/ <a target="_blank" rel="noopener" href="https://gitee.com/luckytuan?utm_source=poper_profile">luckytuan</a>/2021-01-20</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">GiyaYon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://giyayonlib.com/2023/05/05/区块链系统设计（一）区块链基础模块/">http://giyayonlib.com/2023/05/05/区块链系统设计（一）区块链基础模块/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/">软件开发</a><a class="post-meta__tags" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a><a class="post-meta__tags" href="/tags/Java/">Java</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/05/15/%E7%BD%91%E7%BB%9C%E5%B8%B8%E7%94%A8%E5%8D%8F%E8%AE%AE%E5%A4%A7%E5%85%A8%E6%95%B4%E7%90%86/"><i class="fa fa-chevron-left">  </i><span>常用网络协议整理</span></a></div><div class="next-post pull-right"><a href="/2023/03/28/%E5%AE%89%E5%8D%93%E7%A7%BB%E5%8A%A8%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/"><span>Android企业级开发概述</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2023 By GiyaYon</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>